<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mis Reservas - ProServicios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #F8F9FA; 
        }
        .proservicios-primary { background-color: #1A4B8C; }
        .proservicios-text { color: #212529; }
        .proservicios-secondary-text { color: #6C757D; }
        .proservicios-info { color: #17A2B8; }
    </style>
</head>
<body class="min-h-screen">
    <script>
        // Verificación de sesión y logout
        function requireSession() {
            const usuario = localStorage.getItem('usuarioActual');
            if (!usuario) {
                window.location.href = 'login.html';
            }
        }

        function logout() {
            localStorage.removeItem('usuarioActual');
            window.location.href = 'login.html';
        }

        // Notificaciones simuladas (console)
        function notificarSimulada(tipo, titulo, datos) {
            const t = new Date().toISOString();
            console.log(`[Notificacion][${t}] Tipo: ${tipo} - ${titulo}`, datos || {});
        }

        // Función para obtener la clase CSS basada en el estado
        function obtenerClaseEstado(estado) {
            switch (estado) {
                case 'Confirmada':
                    return 'bg-green-100 text-[#28A745]';
                case 'Pendiente de confirmación':
                    return 'bg-yellow-100 text-[#FFC107]';
                case 'Pagada':
                    return 'bg-blue-100 text-[#17A2B8]';
                case 'Cancelada':
                    return 'bg-red-100 text-[#DC3545]';
                default:
                    return 'bg-gray-100 text-gray-700';
            }
        }

        // Función para enviar la reserva seleccionada a la página de pagos
        function iniciarPago(reservaId) {
            let reservas = JSON.parse(localStorage.getItem('reservasProServicios') || '[]');
            const reserva = reservas.find(r => r.id_reserva === reservaId);

            if (reserva) {
                // Guarda solo la reserva a pagar en el localStorage para pagos.html
                localStorage.setItem('reservaActualPago', JSON.stringify(reserva));
                // Notificación simulada en consola: inicio de pago
                notificarSimulada('payment_initiated', 'Inicio de pago', { id_reserva: reserva.id_reserva, total: reserva.total });
                window.location.href = 'pagos.html';
            } else {
                console.error("Reserva no encontrada para el pago.");
            }
        }

        // Función para cargar y mostrar las reservas desde localStorage
        function cargarReservas() {
            const tablaBody = document.getElementById('reservas-body');
            tablaBody.innerHTML = ''; // Limpiar tabla
            
            let reservas = JSON.parse(localStorage.getItem('reservasProServicios') || '[]');
            
            if (reservas.length === 0) {
                tablaBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="p-6 text-center text-lg proservicios-secondary-text">
                            No tienes reservas activas en este momento.
                        </td>
                    </tr>
                `;
                return;
            }

            reservas.forEach(reserva => {
                const fila = document.createElement('tr');
                const estadoClass = obtenerClaseEstado(reserva.estado);
                
                // Determinar si el botón de pago debe estar activo
                const puedePagar = reserva.estado === 'Pendiente de confirmación' || reserva.estado === 'Confirmada';

                fila.innerHTML = `
                    <td class="p-4 whitespace-nowrap text-sm font-semibold text-[#1A4B8C]">${reserva.id_reserva}</td>
                    <td class="p-4 whitespace-nowrap text-sm proservicios-text">${reserva.nombre_servicio}</td>
                    <td class="p-4 whitespace-nowrap text-sm proservicios-secondary-text">${reserva.fecha_simulada}</td>
                    <td class="p-4 whitespace-nowrap">
                        <span class="text-xs font-semibold py-1 px-3 rounded-full ${estadoClass}">
                            ${reserva.estado}
                        </span>
                    </td>
                    <td class="p-4 whitespace-nowrap text-lg font-bold text-[#212529]">$${reserva.total.toFixed(2)}</td>
                    <td class="p-4 whitespace-nowrap text-right">
                        ${puedePagar ? `<button onclick="iniciarPago(${reserva.id_reserva})" class="bg-[#28A745] text-white text-sm py-2 px-4 rounded-lg font-semibold hover:bg-green-600 transition">Pagar Reserva</button>`
                                  : `<button disabled class="bg-gray-400 text-white text-sm py-2 px-4 rounded-lg cursor-not-allowed">Ver Detalle</button>`}
                    </td>
                `;
                tablaBody.appendChild(fila);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            requireSession();
            cargarReservas();
        });
    </script>

    <!-- Navegación Superior -->
    <header class="proservicios-primary text-white shadow-md">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
            <div class="flex items-center">
                <!-- Logo SVG Pequeño -->
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="w-8 h-8 mr-3">
                    <!-- Fondo (Escudo/Contenedor) - Color Blanco -->
                    <path d="M100 10 C150 10, 190 50, 190 100 C190 150, 150 190, 100 190 C50 190, 10 150, 10 100 C10 50, 50 10, 100 10 Z" fill="#FFFFFF"/>
                    <!-- Elemento 1: Libro (Cursos) - Color Azul Principal -->
                    <path d="M60 50 Q80 45, 100 50 L100 150 Q80 155, 60 150 L60 50 M100 50 Q120 45, 140 50 L140 150 Q120 155, 100 150" fill="#1A4B8C" />
                    <!-- Elemento 2: Checkmark (Reservas) - Color Azul Claro/Info -->
                    <path d="M80 100 L110 130 L160 70 L145 55 L110 100 L95 85 Z" fill="#17A2B8" stroke="#FFFFFF" stroke-width="8" stroke-linejoin="round" stroke-linecap="round"/>
                </svg>
                <span class="text-xl font-extrabold">ProServicios</span>
            </div>
            <nav class="flex space-x-4 font-semibold text-sm">
                <a href="catalogo.html" class="hover:border-b-2 border-white pb-1">Catálogo</a>
                <a href="reservas.html" class="border-b-2 border-white pb-1">Mis Reservas</a>
                <a href="#" onclick="logout()" class="bg-white text-[#1A4B8C] px-3 py-1 rounded-full hover:bg-gray-100 transition">Salir</a>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <h1 class="text-3xl font-bold proservicios-text mb-8">Mis Reservas Activas</h1>
        
        <!-- Tabla de Reservas -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-[#F8F9FA]">
                        <tr>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-[#6C757D] uppercase tracking-wider">ID Reserva</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-[#6C757D] uppercase tracking-wider">Servicio</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-[#6C757D] uppercase tracking-wider">Fecha</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-[#6C757D] uppercase tracking-wider">Estado</th>
                            <th scope="col" class="px-4 py-3 text-left text-xs font-medium text-[#6C757D] uppercase tracking-wider">Total</th>
                            <th scope="col" class="relative px-4 py-3"></th>
                        </tr>
                    </thead>
                    <tbody id="reservas-body" class="bg-white divide-y divide-gray-100">
                        <!-- Filas de reservas insertadas por JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</body>
</html>